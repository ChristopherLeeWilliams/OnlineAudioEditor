{% extends 'bootstrap/base.html' %}

{% block title %}
  Index
{% endblock %}

{% block content %}
<meta charset="utf-8">

<!--  Default Flask Bootstrap not working for certain functions, so import-->
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>


<!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
<link rel="stylesheet" href="static/css/main.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<div class="row wrapper" id="row-main">
  <div class="col-md-12" id="content">

    <span class='pull-right' id="album-art-toggle-span">
      <button type="button" class="glyphicon glyphicon-chevron-left btn btn-info" id="album-art-toggle"><span class="font-override"> Album Art</span></button>
    </span>

    <div class="spacer">
      <h1 style="text-align:center">Online Audio Editor</h1></br>
      <input type="file" id="file" name="file"></br>
      <div class="form-inline" id="audio-manipulators">
        <fieldset style="border: solid grey 1px; padding: 1em; text-align: center">
          <legend><div class="audio-container"></div></legend>

          <label for="start-time">Start Time</label>
          <input type="text" class="form-control mb-2 mr-sm-2 mb-sm-0" id="start-time" placeholder="0:00">
          <label for="end-time">End Time</label>
          <input type="text" class="form-control mb-2 mr-sm-2 mb-sm-0" id="end-time" placeholder="3:25">

          <button type="button" class="btn btn-info" onclick="crop_or_split('crop')">Crop</button>
          <button type="button" class="btn btn-info" onclick="crop_or_split('splice')">Splice</button>

          <i class="fa fa-question-circle" aria-hidden="true" style="font-size:18px" id="control-information" data-toggle="tooltip"
            title="CROP: creates new audio track, removing everything before start time and after end time.
              SPLICE: creates new audio track, keeping only everything before start time and after end time."></i>

        </fieldset>
      </div>

      <div class="download-selection">
        <button type="button" class="btn btn-success">Download As</button>
        <select id="download-formats"></select>
      </div>

    </div>
  </div>

  <div class="col-md-3 collapsed" id="album-art">
    <h2 style="text-align:center">Add Album Art</h2>
    <hr style="margin:10%; margin-top: 5%; border: solid black 1px">

    <ul class="nav nav-tabs">
      <li class="active"><a data-toggle="tab" href="#file-input-div">File</a></li>
      <li><a data-toggle="tab" href="#link-input-div">URL</a></li>
      <li><a data-toggle="tab" href="#search-input-div">Search</a></li>
      <li><a style="cursor: pointer; color: red; font-weight: bold" onclick="cancel_image()">Clear</a></li>
    </ul></br>

    <div class="tab-content">
      <div id="file-input-div" class="tab-pane fade in active">
        <input type='file' onchange="readURL(this);" id="image-file"/></br>
      </div>
      <div id="link-input-div" class="tab-pane fade">
        Image URL: <input id="image-url" type="url" size="20">
        <button type="button" class="btn btn-info" id="image-url-preview-btn">Preview</button></br></br>
      </div>
      <div id="search-input-div" class="tab-pane fade">
        Artist: <input id="artist" type="text" size="10"><br>
        Album:  <input id="album" type="text" size="10"><br>
        <button type="button" class="btn btn-info" onclick="download_search()">Search</button></br></br>
      </div>
    </div></br>

    <div class="preview-image-div">
      <img id="preview-image" src="" alt="your image" height="300" width="300"/>
    </div>
  <!-- </br><button type="button" class="btn btn-warning" onclick="cancel_image()">Cancel</button> -->
  </div>
</div>

{% endblock %}

{% block scripts %}
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
    $(function(){ // When Page Has Fully Loaded ->

      // Generate the drop down selectors for downloading the audio
      //  gets supported types from server
      create_download_dropdown();

      // EVENT - when file input changes:
      $("#file").change(function(){
        create_audio_player();
      });

      // Toggle Audio Sidebar
      $('#album-art-toggle').click(function() {
        $("#album-art").toggleClass("collapsed");
        $("#content").toggleClass("col-md-12 col-md-9");
        $('#album-art-toggle').toggleClass("glyphicon-chevron-left glyphicon-chevron-right");
      });

      $('#image-url-preview-btn').click(function() {
        var url = $('#image-url').val();
        if(url === "") {alert("No link entered!"); return;}
        $('#preview-image').attr('src', url);
        $('.preview-image-div').show();
      });
    });

    function cancel_image() {
      $('#image-file').val("");
      $('#image-url').val("");
      $('#preview-image').attr('src', "");
      $('.preview-image-div').hide();
    }

    function download_search(){
      var artist = $('#artist').val();
      var album = $('#album').val();
      var data = {
            "artist" : artist,
            "album" : album
      }
      $.ajax({
        url: '/downloadAlbumArt',
        method: 'POST',
        data: JSON.stringify(data),
        contentType:"application/json; charset=utf-8",
        dataType: 'json'
      })
      .done(function(response) {
          console.log(response);
      })
      .fail(function(err) { console.log(err) })
      .always(function() {});
    }

    function crop_or_split(operation) {
      // Makes an ajax request to url based off of the operation type
      url = "";
      if(operation === "crop") { url = "/crop"; }
      else if (operation === "splice") { url = "/splice"; }
      else { alert("Unrecognized operation"); return -1; }

      // Get timestamps
      var times = get_time_stamps_miliseconds();
      if(times == -1) {alert("Error: Incorrect timestamps or audio not selected"); return -1;}

      // Get audio data
      var audio_data = get_audio_info();

      // Format ajax data
      var data = {
        "base64": audio_data["base64"],
        "contentType": audio_data["contentType"],
        "startTime": times["start"],
        "endTime": times["end"]
      }
      // console.log(data);
      // Remove player and start load icon
      remove_audio_player();
      start_load_icon();

      $.ajax({
        url: url,
        method: 'POST',
        data: JSON.stringify(data),
        contentType:"application/json; charset=utf-8",
        dataType: 'json'
      })
      .done(function(response) {
        // Temp: print response in console
        console.log(response);

        // Uncomment code below when audio source can be rewritten with response data
        stop_load_icon();
        // if(response["error"] != null) {
        //   alert(response["error"])
        // } else {
        //   var new_src = "data:"+response["contentType"]+";base64,"+response["song"];
        //   console.log(new_src);
        //   create_audio_player(new_src);
        // }
      })
      .fail(function(err) { console.log(err["statusCode"]); stop_load_icon();})
      .always(function() {});
    }

    function timestamp_to_mili(timestamp) {

      // Add format padding if missing
      if(timestamp.indexOf(":") == -1) { timestamp = "00"+timestamp +":0"; }
      else { timestamp = "00"+timestamp +"00"; }

      // Split timestamp on colon to separate minutes and seconds
      var timestamp = timestamp.split(":");
      if(timestamp.length > 2) {return -1;}
      var time = 0;

      // Get value of number before colon
      if(typeof timestamp[0] === "undefined") { return -1; }
      var num1 = Number(timestamp[0]);
      if(!Number.isInteger(num1)) {return -1;}
      // console.log("Num1: "+num1);
      if(num1 < 0) {return -1;}
      time += num1 * 60 * 1000;

      // Get value of number after colon
      if(typeof timestamp[1] === "undefined") { return -1; }
      var num2 = Number(timestamp[1]);
      if(!Number.isInteger(num2)) {return -1;}
      // console.log("Num2: "+num2);
      if(num2 < 0) {return -1;}
      time += num2 * 1000;

      return time;
    }

    function create_audio_player(src) {
      // Generates an audio player with a supplied source
      //  OR the source found from the input file
      var audio_player = document.createElement('audio')
      audio_player.id = 'audio-player';
      audio_player.controls = 'controls';

      if (typeof src === 'undefined') {
        var fileReader = new FileReader();
        fileReader.onload = function () { audio_player.src = fileReader.result; }; // base 64 audio data (with prepended formatting)
        fileReader.readAsDataURL($('#file').prop('files')[0]);
      } else {audio_player.src = src;}

      remove_audio_player();
      $('.audio-container').append(audio_player);
    }

    function get_audio_info() {
      // Returns audio info in js object format:
      // {
      //   contentType: "type of audio, EX: audio/mp3",
      //   base64: "base64 ascii encoded audio data"
      // }
      var src = $('#audio-player').attr('src');
      if (typeof src === 'undefined') { return -1; }
      var base64_split = src.split("base64,");
      return {
        contentType: base64_split[0].split("data:")[1].split(";")[0],
        base64: base64_split[1]
      };
    }

    function readURL(input) {
      if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
          $('#preview-image').attr('src', e.target.result);
          $('.preview-image-div').show();
        }
        reader.readAsDataURL(input.files[0]);
        }
      }

    function remove_audio_player() {
      // Removes existing audio player
      $('.audio-container').empty();
    }

    function start_load_icon() {
      // Start awesome loader icon
      $('.audio-container').append('<i class="fa fa-refresh fa-spin" style="font-size:24px"></i>');
    }

    function stop_load_icon() {
      // Stop awesome loader icon
      $('.audio-container').empty();
    }

    function create_download_dropdown() {
      $.get( "/supportedFormats", function( data ) {
        // $( ".result" ).html( data );
        $.each(data, function(key, value) {
          $('#download-formats')
            .append($("<option></option>")
            .attr("value",key)
            .text(value));
          });
      });
    }

    function get_time_stamps_miliseconds() {
      var start = $('#start-time').val();
      var end = $('#end-time').val();

      try {
        var start_mili = timestamp_to_mili(start);
        var end_mili = timestamp_to_mili(end);
        if((start_mili == -1) || (end_mili == -1)) {return -1;}

        // Get max possible time
        var max_time = document.getElementById("audio-player").duration * 1000;

        start_mili = (start_mili < 0) ? 0 : start_mili;
        end_mili = (end_mili > max_time) ? max_time : end_mili;

        // console.log(start_mili + " and " + end_mili);
        if(start_mili >= end_mili) { return -1; }

        return {
          start: start_mili,
          end: end_mili
        };
      } catch (err) {
        // console.log(err);
        return -1;
      }
    }
  </script>
{% endblock %}
